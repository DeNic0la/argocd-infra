kind: Kustomization
apiVersion: kustomize.config.k8s.io/v1beta1

resources:
  # SEALED SECRETS
  - sealedsecret_repo-creds-argocd-infra.yaml
  - sealedsecret_repo-creds-konfi-infra.yaml
  - sealedsecret_argocd-secret-patch.yaml

  - github.com/argoproj/argo-cd//manifests/namespace-install?ref=v3.1.1
#  - github.com/argoproj/argo-cd//manifests/crds?ref=v3.1.1
  #  - ./base/argocd-ssh-known-hosts-cm.yaml

  - ./base/argo-cd-ui-ingress.yaml

# PROJECTS
  - projects/project_argocd.yaml
  - projects/project_konfi.yaml

# APPLICATIONS
  - applications/application_argocd.yaml
  - applications/application_konfi-dev.yaml
#  - applications/applicationset_konfi.yaml

secretGenerator:
  - name: argocd-server-tls
    type: kubernetes.io/tls
    options:
      disableNameSuffixHash: true

patches:
  - path: base/argo-cd-cm.yaml
    target:
      name: argocd-cm
      labelSelector:
        app.kubernetes.io/name=argocd-cm
      kind: ConfigMap
  - target:
      kind: Secret
      name: argocd-secret
      labelSelector:
        app.kubernetes.io/name=argocd-secret
    patch: |-
      - op: add
        path: /metadata/annotations
        value: "sealedsecrets.bitnami.com/managed: true"
        
#replacements:
#  - source:
#      name: argocd-secret-patch
#      kind: Secret
#      version: v1
#      namespace: argocd
#      fieldPath: data
#
#    targets:
#      - select:
#          name: argocd-secret
#          kind: Secret
#          version: v1
#          namespace: argocd

        

